services:
  n8n-postgres:
    image: postgres:15
    container_name: n8n-postgres
    restart: unless-stopped
    environment:
      # Change these in production!
      - POSTGRES_USER=n8n
      - POSTGRES_PASSWORD=${N8N_DB_PASSWORD:-changeme123}
      - POSTGRES_DB=n8n
      - PGDATA=/var/lib/postgresql/data/pgdata
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U n8n']
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - n8n-network

  n8n:
    image: n8nio/n8n:1.120.0
    container_name: n8n
    restart: unless-stopped
    ports:
      - "5678:5678"
    volumes:
      - ./data/n8n:/home/node/.n8n
      - ./workflows:/home/node/workflows
      - ./backups:/home/node/backups
      - /home/zaphod-beeblebox/src/n8n-workflows/social-media-system:/data/social-media-system
      - /tmp:/tmp
      - /home/zaphod-beeblebox/src/n8n-workflows/mining-ai:/data/mining-ai

    environment:
      # Database connection
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=n8n-postgres
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=n8n
      - DB_POSTGRESDB_USER=n8n
      - DB_POSTGRESDB_PASSWORD=${N8N_DB_PASSWORD:-changeme123}

      # Basic configuration
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - NODE_ENV=production
      - TZ=America/New_York

      # Webhook URL (change for production)
      - WEBHOOK_URL=${WEBHOOK_URL:-http://localhost:5678}

      # Execution mode (queue recommended for production)
      - EXECUTIONS_MODE=regular
      # Use 'queue' for better concurrency:
      # - EXECUTIONS_MODE=queue

      # Logging
      - N8N_LOG_LEVEL=info
      - N8N_LOG_OUTPUT=console

      # Execution data retention
      - EXECUTIONS_DATA_SAVE_ON_SUCCESS=all
      - EXECUTIONS_DATA_SAVE_ON_ERROR=all
      - EXECUTIONS_DATA_SAVE_MANUAL_EXECUTIONS=true

      # Auto-prune old executions (optional)
      # - EXECUTIONS_DATA_PRUNE=true
      # - EXECUTIONS_DATA_MAX_AGE=168  # 7 days in hours

      # Security
      # Note: Basic auth is deprecated in newer n8n versions
      # n8n now has built-in user management - just create an account on first run
      - N8N_SECURE_COOKIE=true

      # Payload size (increase for large data)
      - N8N_PAYLOAD_SIZE_MAX=16

      # Community nodes
      - N8N_COMMUNITY_PACKAGES_ENABLED=true

      # Personalization (optional)
      - N8N_PERSONALIZATION_ENABLED=true
      - N8N_VERSION_NOTIFICATIONS_ENABLED=true
      - N8N_DIAGNOSTICS_ENABLED=false
      - N8N_HIRING_BANNER_ENABLED=false
      # Custom environment variables for workflows
      - BLOG_API_KEY=${BLOG_API_KEY}

      - PYTHONPATH=/data/social-media-system
      - DB_PATH=/tmp/social_posts.db
      - TWITTER_API_KEY=${TWITTER_API_KEY}
      - TWITTER_API_SECRET=${TWITTER_API_SECRET}
      - TWITTER_ACCESS_TOKEN=${TWITTER_ACCESS_TOKEN}
      - TWITTER_ACCESS_SECRET=${TWITTER_ACCESS_SECRET}

    extra_hosts:
      - "host.docker.internal:host-gateway"

    depends_on:
      n8n-postgres:
        condition: service_healthy
    networks:
      - n8n-network

networks:
  n8n-network:
    driver: bridge

# n8n - Workflow Automation for LLMs
#
# Access web UI: http://localhost:5678
#
# Quick Start:
# 1. Create .env file with your settings (see below)
# 2. Fix permissions: mkdir -p ./data/n8n && sudo chown -R 1000:1000 ./data/n8n
# 3. docker-compose up -d
# 4. Open http://localhost:5678
# 5. Create first user (becomes admin)
# 6. Start building workflows!
#
# IMPORTANT: Permission Fix Required
# n8n runs as UID 1000 (node user). Before first run:
#   mkdir -p ./data/n8n
#   sudo chown -R 1000:1000 ./data/n8n
#
# Example .env file (create this file):
# N8N_DB_PASSWORD=your_secure_database_password
# WEBHOOK_URL=https://your-domain.com
#
# Security Notes:
# - n8n has built-in user management (create account on first run)
# - Basic auth is deprecated in newer versions
# - Use a reverse proxy (Caddy/nginx) with HTTPS for production
# - Set N8N_SECURE_COOKIE=true when behind HTTPS
#
# Connect to LLMs (if on same Docker network):
# - Ollama: http://ollama:11434
# - vLLM: http://vllm:8000/v1
# - LocalAI: http://localai:8082/v1
# - Stable Diffusion: http://stable-diffusion:7860
#
# Data stored in:
# - ./data/postgres/ - Database
# - ./data/n8n/ - n8n config and data
# - ./workflows/ - Workflow exports
# - ./backups/ - Manual backups
#
# Backup:
# docker exec n8n n8n export:workflow --all --output=/home/node/backups/workflows.json
#
# Restore:
# docker exec n8n n8n import:workflow --input=/home/node/backups/workflows.json
