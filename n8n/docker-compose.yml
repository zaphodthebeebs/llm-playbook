version: '3.8'

services:
  n8n-postgres:
    image: postgres:15
    container_name: n8n-postgres
    restart: unless-stopped
    environment:
      # Change these in production!
      - POSTGRES_USER=n8n
      - POSTGRES_PASSWORD=${N8N_DB_PASSWORD:-changeme123}
      - POSTGRES_DB=n8n
      - PGDATA=/var/lib/postgresql/data/pgdata
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U n8n']
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - n8n-network

  n8n:
    image: n8nio/n8n:latest
    container_name: n8n
    restart: unless-stopped
    ports:
      - "5678:5678"
    volumes:
      - ./data/n8n:/home/node/.n8n
      - ./workflows:/home/node/workflows
      - ./backups:/home/node/backups
    environment:
      # Database connection
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=n8n-postgres
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=n8n
      - DB_POSTGRESDB_USER=n8n
      - DB_POSTGRESDB_PASSWORD=${N8N_DB_PASSWORD:-changeme123}

      # Basic configuration
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - NODE_ENV=production
      - TZ=America/New_York

      # Webhook URL (change for production)
      - WEBHOOK_URL=${WEBHOOK_URL:-http://localhost:5678}

      # Execution mode (queue recommended for production)
      - EXECUTIONS_MODE=regular
      # Use 'queue' for better concurrency:
      # - EXECUTIONS_MODE=queue

      # Logging
      - N8N_LOG_LEVEL=info
      - N8N_LOG_OUTPUT=console

      # Execution data retention
      - EXECUTIONS_DATA_SAVE_ON_SUCCESS=all
      - EXECUTIONS_DATA_SAVE_ON_ERROR=all
      - EXECUTIONS_DATA_SAVE_MANUAL_EXECUTIONS=true

      # Auto-prune old executions (optional)
      # - EXECUTIONS_DATA_PRUNE=true
      # - EXECUTIONS_DATA_MAX_AGE=168  # 7 days in hours

      # Security
      - N8N_SECURE_COOKIE=false
      # Enable for production:
      # - N8N_BASIC_AUTH_ACTIVE=true
      # - N8N_BASIC_AUTH_USER=admin
      # - N8N_BASIC_AUTH_PASSWORD=${N8N_ADMIN_PASSWORD:-changeme}

      # Payload size (increase for large data)
      - N8N_PAYLOAD_SIZE_MAX=16

      # Community nodes
      - N8N_COMMUNITY_PACKAGES_ENABLED=true

      # Personalization (optional)
      - N8N_PERSONALIZATION_ENABLED=true
      - N8N_VERSION_NOTIFICATIONS_ENABLED=true
      - N8N_DIAGNOSTICS_ENABLED=false
      - N8N_HIRING_BANNER_ENABLED=false

    depends_on:
      n8n-postgres:
        condition: service_healthy
    networks:
      - n8n-network
      - llm-network  # Connect to LLM services

networks:
  n8n-network:
    driver: bridge
  llm-network:
    external: true
    name: llm_default  # Adjust if your LLM network has different name

# n8n - Workflow Automation for LLMs
#
# Access web UI: http://localhost:5678
#
# Quick Start:
# 1. docker-compose up -d
# 2. Open http://localhost:5678
# 3. Create first user (becomes admin)
# 4. Start building workflows!
#
# Connect to LLMs:
# - Ollama: http://ollama:11434
# - vLLM: http://vllm:8000/v1
# - LocalAI: http://localai:8082/v1
# - KoboldCpp: http://koboldcpp:5001
# - Stable Diffusion: http://stable-diffusion:7860
#
# Security (Production):
# - Set N8N_DB_PASSWORD environment variable
# - Enable N8N_BASIC_AUTH_ACTIVE
# - Set N8N_BASIC_AUTH_PASSWORD
# - Use HTTPS with reverse proxy
# - Set proper WEBHOOK_URL
#
# Environment Variables:
# - N8N_DB_PASSWORD: Database password (default: changeme123)
# - WEBHOOK_URL: External URL for webhooks (default: http://localhost:5678)
# - N8N_ADMIN_PASSWORD: Admin password if basic auth enabled
#
# Example .env file:
# N8N_DB_PASSWORD=mysecretpassword
# WEBHOOK_URL=https://n8n.yourdomain.com
# N8N_ADMIN_PASSWORD=adminpassword
#
# Data stored in:
# - ./data/postgres/ - Database
# - ./data/n8n/ - n8n data
# - ./workflows/ - Workflow exports
# - ./backups/ - Manual backups
#
# Backup:
# docker exec n8n n8n export:workflow --all --output=/home/node/backups/workflows.json
#
# Restore:
# docker exec n8n n8n import:workflow --input=/home/node/backups/workflows.json
